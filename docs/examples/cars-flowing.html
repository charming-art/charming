<!doctype html>
<notebook theme="air">
  <title>Car Flowing</title>
  <script id="0" type="text/markdown">
    # Car Flowing

  </script>
  <script id="5" type="application/vnd.observable.javascript" pinned="">
    {
      const width = 600,
        height = 200,
        size = 20,
        cols = Math.floor(width / size),
        rows = Math.floor(height / size),
        fields = cm.cross(cm.range(cols), cm.range(rows)),
        values = cm.range(cols * rows),
        auto = createAuto(values, cols, rows, size),
        cars = cm.range(120).map(() =>
          object({
            location: cm.vec(cm.random(width), cm.random(height)),
            velocity: cm.vec(),
            r: 4,
            maxSpeed: cm.random(2, 5),
            maxForce: cm.random(0.1, 0.5)
          })
        );

      initFields(fields, values);

      function update(app) {
        app.append(cm.clear, { fill: "white" });

        app
          .data(fields)
          .append(cm.group, {
            x: (d) => d[0] * size + size / 2,
            y: (d) => d[1] * size + size / 2,
            rotate: ([x, y]) => values[x + y * cols]
          })
          .append(cm.link, {
            x: (-size / 2) * 0.5,
            y: 0,
            x1: (size / 2) * 0.5,
            y1: 0
          });

        app
          .data(cars)
          .process(cm.each, auto)
          .process(cm.each, move)
          .process(cm.each, constrainX)
          .process(cm.each, constrainY)
          .append(cm.group, {
            x: (d) => d.location.x,
            y: (d) => d.location.y,
            rotate: (d) => d.velocity.angle()
          })
          .append(cm.triangle, {
            x: (d) => d.r * 2,
            y: 0,
            x1: (d) => -d.r * 2,
            y1: (d) => -d.r,
            x2: (d) => -d.r * 2,
            y2: (d) => d.r,
            fill: cm.rgb(175),
            stroke: cm.rgb(0),
            strokeWidth: 2
          });
      }

      function mouseClick() {
        initFields(fields, values);
      }

      function dispose(app) {
        invalidation.then(() => app.dispose());
      }

      return cm
        .app({ width, height })
        .on("update", update)
        .on("mouseClick", mouseClick)
        .call(border)
        .call(dispose)
        .start()
        .node();
    }
  </script>
  <script id="133" type="application/vnd.observable.javascript" pinned="">
    function initFields(fields, values) {
      const noise = cm.randomNoise(0, cm.TWO_PI * 2);
      for (let m = 0; m < fields.length; m++) {
        const [i, j] = fields[m];
        values[m] = noise(j * 0.1, i * 0.1);
      }
    }
  </script>
  <script id="46" type="application/vnd.observable.javascript" pinned="">
    function createAuto(values, cols, rows, size) {
      function lookup(x, y) {
        const i = cm.clamp((x / size) | 0, 0, cols - 1);
        const j = cm.clamp((y / size) | 0, 0, rows - 1);
        const angle = values[j * cols + i];
        return cm.vecFromAngle(angle);
      }
      return (d) => {
        const desired = lookup(d.location.x, d.location.y);
        desired.mag(d.maxSpeed);
        const steer = cm.vecSub(desired, d.velocity);
        steer.clamp(d.maxForce);
        applyForce(d, steer);
      };
    }
  </script>
  <script id="94" type="application/vnd.observable.javascript" pinned="">
    function constrainX(d, i, _, flow) {
      const app = flow.app();
      const width = app.prop("width");
      if (d.location.x < 0) d.location.x += width;
      if (d.location.x > width) d.location.x -= width;
    }
  </script>
  <script id="97" type="application/vnd.observable.javascript" pinned="">
    function constrainY(d, i, _, flow) {
      const app = flow.app();
      const height = app.prop("height");
      if (d.location.y < 0) d.location.y += height;
      if (d.location.y > height) d.location.y -= height;
    }
  </script>
  <script id="34" type="application/vnd.observable.javascript" pinned="">
    function move(d) {
      d.velocity.add(d.acceleration);
      d.location.add(d.velocity);
      d.acceleration.mult(0);
    }
  </script>
  <script id="53" type="application/vnd.observable.javascript" pinned="">
    function applyForce(d, force) {
      const a = cm.vecDiv(force, d.mass);
      d.acceleration.add(a);
    }
  </script>
  <script id="11" type="application/vnd.observable.javascript" pinned="">
    function object(options) {
      return {
        location: cm.vec(),
        velocity: cm.vec(),
        acceleration: cm.vec(),
        mass: 1,
        ...options
      };
    }
  </script>
  <script id="38" type="application/vnd.observable.javascript" pinned="">
    function border(app) {
      app.node().style.border = "solid #000 1px"
    }
  </script>
  </notebook>
