<!doctype html>
<notebook theme="air">
  <title>Attractor</title>
  <script id="0" type="text/markdown">
    # Attractor
  </script>
  <script id="11" type="module">
    const replay = view(Inputs.button("Replay"));
  </script>
  <script id="8" type="module" pinned="">
    replay;

    const width = 600,
      height = 200,
      centerX = width / 2,
      centerY = height / 2,
      attractor = object({
        mass: 20,
        G: 1,
        location: cm.vec(centerX, centerY),
      }),
      mover = object({
        location: cm.vec(centerX, centerY - 50),
        velocity: cm.vec(1, 0),
        acceleration: cm.vec(),
        mass: 5,
      }),
      applyAttraction = attraction(attractor);

    function update(app) {
      app.append(cm.clear, { fill: cm.rgb(255) });

      app
        .datum(mover)
        .process(cm.each, applyAttraction)
        .process(cm.each, move)
        .append(cm.circle, {
          x: (d) => d.location.x,
          y: (d) => d.location.y,
          r: (d) => d.mass,
          fill: cm.rgb(175),
          stroke: "#000",
          strokeWidth: 2,
        });

      app
        .datum(attractor) // Convert to an array.
        .append(cm.circle, {
          x: (d) => d.location.x,
          y: (d) => d.location.y,
          r: (d) => d.mass,
          fill: cm.rgb(175),
          stroke: "#000",
          strokeWidth: 5,
        });
    }

    function dispose(app) {
      invalidation.then(() => app.dispose());
    }

    function frame(app) {
      app.node().style.border = "solid #000 1px";
    }

    const node = cm.app({ width, height }).on("update", update).call(dispose).call(frame).start().node();

    display(node);
  </script>
  <script id="20" type="module" pinned="">
    function object(options) {
      return {
        location: cm.vec(),
        velocity: cm.vec(),
        acceleration: cm.vec(),
        mass: 1,
        aVelocity: 0,
        aAcceleration: 0,
        rotation: 0,
        ...options,
      };
    }
  </script>
  <script id="22" type="module" pinned="">
    function force(d) {
      const callback = typeof d === "function" ? d : () => d;
      return (d, ...params) => {
        const f = callback(d, ...params);
        if (f === null || f === undefined) return;
        const a = cm.vecDiv(f, d.mass);
        d.acceleration.add(a);
      };
    }
  </script>
  <script id="25" type="module" pinned="">
    function move(d) {
      d.velocity.add(d.acceleration);
      d.location.add(d.velocity);
      d.acceleration.mult(0);
    }
  </script>
  <script id="59" type="module" pinned="">
    function attraction(attractor) {
      const { mass, G } = attractor;
      return (d) => {
        const dir = cm.vecSub(attractor.location, d.location);
        const dist = cm.vecClamp(dir, 5, 25).mag();
        const strength = (G * mass * d.mass) / (dist * dist);
        const f = cm.vecMag(dir, strength);
        const apply = force(f);
        apply(d);
      };
    }
  </script>
</notebook>
