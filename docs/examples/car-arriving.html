<!doctype html>
<notebook theme="air">
  <title>Car Arriving</title>
  <script id="0" type="text/markdown">
    # Car Arriving

  </script>
  <script id="5" type="application/vnd.observable.javascript" pinned="">
    {
      const width = 600,
        height = 200,
        target = object(),
        car = object({
          location: cm.vec(width / 2, height / 2),
          maxSpeed: 4,
          maxForce: 0.1,
          r: 6
        });

      function update(app) {
        app.append(cm.clear, { fill: cm.rgb(255) });

        app
          .datum(target)
          .process(cm.each, (d) =>
            d.location.set(app.prop("mouseX"), app.prop("mouseY"))
          )
          .append(cm.circle, {
            x: (d) => d.location.x,
            y: (d) => d.location.y,
            r: 24,
            stroke: "black",
            fill: cm.rgb(175),
            strokeWidth: 2
          });

        const group = app
          .datum(car)
          .process(cm.each, arrive(target))
          .process(cm.each, move)
          .append(cm.group, {
            x: (d) => d.location.x,
            y: (d) => d.location.y,
            rotate: (d) => d.velocity.angle()
          });

        group.append(cm.triangle, {
          x: (d) => d.r * 2,
          y: 0,
          x1: (d) => -d.r * 2,
          y1: (d) => -d.r,
          x2: (d) => -d.r * 2,
          y2: (d) => d.r,
          fill: cm.rgb(175),
          stroke: cm.rgb(0),
          strokeWidth: 2
        });

        group.append(cm.circle, {
          x: (d) => d.r * 2,
          y: 0,
          r: 5,
          fill: "red"
        });
      }

      function dispose(app) {
        invalidation.then(() => app.dispose());
      }

      return cm
        .app({ width, height })
        .on("update", update)
        .call(border)
        .call(dispose)
        .start()
        .node();
    }
  </script>
  <script id="46" type="application/vnd.observable.javascript" pinned="">
    function arrive(target) {
      return (d) => {
        const desired = cm.vecSub(target.location, d.location);

        const distance = desired.mag();
        const scale = cm.scaleLinear([0, 100], [0, d.maxSpeed]);
        if (distance > 100) desired.mag(d.maxSpeed);
        else desired.mag(scale(distance));

        const steer = cm.vecSub(desired, d.velocity);
        steer.clamp(d.maxForce);
        applyForce(d, steer);
      };
    }
  </script>
  <script id="34" type="application/vnd.observable.javascript" pinned="">
    function move(d) {
      d.velocity.add(d.acceleration);
      d.location.add(d.velocity);
      d.acceleration.mult(0);
    }
  </script>
  <script id="53" type="application/vnd.observable.javascript" pinned="">
    function applyForce(d, force) {
      const a = cm.vecDiv(force, d.mass);
      d.acceleration.add(a);
    }
  </script>
  <script id="11" type="application/vnd.observable.javascript" pinned="">
    function object(options) {
      return {
        location: cm.vec(),
        velocity: cm.vec(),
        acceleration: cm.vec(),
        mass: 1,
        ...options
      };
    }
  </script>
  <script id="38" type="application/vnd.observable.javascript" pinned="">
    function border(app) {
      app.node().style.border = "solid #000 1px"
    }
  </script>
  <script id="7" type="application/vnd.observable.javascript" pinned="">
    cm = require("@charming-art/charming@0.0.6")
  </script>
  </notebook>
